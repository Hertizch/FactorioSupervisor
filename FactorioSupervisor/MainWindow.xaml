<Window x:Name="WindowRoot"
        x:Class="FactorioSupervisor.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:c="clr-namespace:FactorioSupervisor.Resources.Controls"
        xmlns:conv="clr-namespace:FactorioSupervisor.Converters"
        xmlns:componentModel="clr-namespace:System.ComponentModel;assembly=WindowsBase"
        xmlns:i="http://schemas.microsoft.com/expression/2010/interactivity"
        xmlns:local="clr-namespace:FactorioSupervisor"
        xmlns:system="clr-namespace:System;assembly=mscorlib"
        xmlns:ei="http://schemas.microsoft.com/expression/2010/interactions"
        mc:Ignorable="d"
        Height="550" Width="850"
        WindowStartupLocation="CenterScreen"
        DataContext="{StaticResource BaseVm}"
        Style="{StaticResource MainWindow}">

    <Window.CommandBindings>
        <CommandBinding Command="ApplicationCommands.Close" Executed="CloseCommandHandler" />
    </Window.CommandBindings>

    <Window.Resources>
        <conv:ValueToVisibilityConverter x:Key="ValueToVisibilityConverter" />
        <conv:InvertedBooleanConverter x:Key="InvertedBooleanConverter" />
        
        <CollectionViewSource x:Key="ModsVs" Source="{Binding Path=ModsVm.Mods}" IsLiveFilteringRequested="True">
            <CollectionViewSource.SortDescriptions>
                <componentModel:SortDescription PropertyName="Title" />
            </CollectionViewSource.SortDescriptions>
            <CollectionViewSource.LiveFilteringProperties>
                <system:String>Title</system:String>
                <system:String>Name</system:String>
            </CollectionViewSource.LiveFilteringProperties>
        </CollectionViewSource>
    </Window.Resources>

    <Grid>
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="100" />
                <RowDefinition />
            </Grid.RowDefinitions>

            <!-- Root - Top -->
            <Grid Background="{StaticResource AccentColorDark}">
                <Grid.Effect>
                    <DropShadowEffect Direction="0" Opacity="0.5" />
                </Grid.Effect>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition />
                    <ColumnDefinition />
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="35" />
                    <RowDefinition />
                </Grid.RowDefinitions>

                <!-- Titlebar -->
                <Grid Grid.ColumnSpan="2">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition />
                        <ColumnDefinition />
                    </Grid.ColumnDefinitions>
                    <StackPanel Orientation="Horizontal">
                        <c:IconToggleButton x:Name="SettingsButton" Style="{StaticResource SettingsButton}" MarginCustom="10" ToolTip="Settings" IsChecked="False" />
                    </StackPanel>
                    <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                        <c:IconButton Style="{StaticResource TitlebarButton}" Icon="{StaticResource IconClose}" MarginCustom="12" Width="35" Command="ApplicationCommands.Close" />
                    </StackPanel>
                </Grid>

                <!-- Sub titlebar -->
                <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="50,0,0,0" Grid.ColumnSpan="2">
                    <TextBlock Text="Factorio Supervisor" Foreground="White" FontSize="24" FontFamily="Segoe UI Semilight" />
                </StackPanel>
            </Grid>

            <!-- Progress bar top -->
            <Grid Row="1">
                <ProgressBar Height="2" VerticalAlignment="Top" Foreground="{StaticResource AccentColorLight}" Background="Transparent" BorderBrush="Transparent" IsIndeterminate="{Binding Path=ModsVm.ShowProgressBar}" />
            </Grid>

            <!-- Root - Content -->
            <Grid Row="1" Margin="20,30,20,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="1.2*" />
                    <ColumnDefinition Width="40" />
                    <ColumnDefinition Width="2.5*" />
                </Grid.ColumnDefinitions>

                <!-- Left column -->
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition />
                    </Grid.RowDefinitions>

                    <!-- Search box -->
                    <Grid Margin="0,0,0,12">
                        <TextBox Style="{StaticResource SearchTextBox}" Text="{Binding ElementName=WindowRoot, Path=SearchFilter, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, Delay=50}" />
                    </Grid>

                    <Grid Row="1" Margin="0,0,0,12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <StackPanel Height="30" Orientation="Horizontal">
                            <!--
                            <c:IconButton Style="{StaticResource SubTitlebarButton}" Icon="{StaticResource IconCheckmarkChecked}" Command="{Binding Path=ModsVm.ToggleEnableModsCmd}" ViewboxWidth="18" Width="30" ToolTip="Enable all" />
                            -->
                            <ComboBox x:Name="ProfilesComboBox" Style="{StaticResource ProfilesComboBox}" ItemContainerStyle="{StaticResource ProfilesComboBoxItem}" ItemsSource="{Binding Path=ProfilesVm.Profiles}" DisplayMemberPath="Name" SelectedItem="{Binding Path=ProfilesVm.SelectedProfile, Mode=OneWay}">
                                <ComboBox.ContextMenu>
                                    <ContextMenu x:Name="ProfilesContextMenu">
                                        <MenuItem Header="New" Command="{Binding Path=ProfilesVm.CreateProfileCmd}" />
                                    </ContextMenu>
                                </ComboBox.ContextMenu>
                                <i:Interaction.Triggers>
                                    <i:EventTrigger SourceObject="{Binding ElementName=ProfilesComboBox}" EventName="SelectionChanged">
                                        <i:InvokeCommandAction Command="{Binding Path=ProfilesVm.SwitchProfileCmd}" CommandParameter="{Binding ElementName=ProfilesComboBox, Path=SelectedItem}" />
                                    </i:EventTrigger>
                                </i:Interaction.Triggers>
                            </ComboBox>
                            
                            <c:IconButton Style="{StaticResource SubTitlebarButton}" Icon="{StaticResource IconCheckUpdate}" Command="{Binding Path=ModsVm.GetModRemoteDataCmd}" IsEnabled="{Binding Path=ModsVm.IsCheckingForUpdates, Converter={StaticResource InvertedBooleanConverter}}" Width="30" ToolTip="Check for updates" />
                            <c:IconButton Style="{StaticResource SubTitlebarButton}" Icon="{StaticResource IconDownload}" Command="{Binding Path=ModsVm.DownloadModCmd}" IsEnabled="{Binding Path=ModsVm.IsUpdating, Converter={StaticResource InvertedBooleanConverter}}" Width="30" ToolTip="Update all" />
                        </StackPanel>
                        <StackPanel Grid.Column="1" Height="30" Orientation="Horizontal" HorizontalAlignment="Right">
                            <c:IconButton Style="{StaticResource SubTitlebarButton}" Icon="{StaticResource IconDots}" Width="30" ToolTip="Options" />
                        </StackPanel>
                    </Grid>

                    <!-- Mod list -->
                    <ScrollViewer Grid.Row="3">
                        <ListBox Style="{StaticResource GenericListBox}" ItemContainerStyle="{StaticResource GenericListBoxItem}" 
                             ItemsSource="{Binding Source={StaticResource ModsVs}}" SelectedItem="{Binding Path=ModsVm.SelectedMod, Mode=TwoWay}">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>
                                        <StackPanel Orientation="Horizontal">
                                            <CheckBox Style="{StaticResource GenericCheckBox}" IsChecked="{Binding Path=IsEnabled, Mode=TwoWay}" />
                                            <TextBlock Text="{Binding Path=Title}">
                                                <TextBlock.Style>
                                                    <Style TargetType="{x:Type TextBlock}">
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Path=HasError}" Value="True">
                                                                <Setter Property="Foreground" Value="Red" />
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding Path=UpdateAvailable}" Value="True">
                                                                <Setter Property="Foreground" Value="#B2FFFF00" />
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding Path=IsUpdating}" Value="True">
                                                                <Setter Property="Foreground" Value="Yellow" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                            </TextBlock>
                                            <TextBlock Text="{Binding Path=ProgressPercentage, StringFormat={} - Updating {0}%}" Visibility="{Binding Path=IsUpdating, Converter={StaticResource ValueToVisibilityConverter}}" Foreground="Yellow" />
                                        </StackPanel>

                                        <Viewbox Grid.Column="1" Width="8" Visibility="{Binding Path=UpdateAvailable, Converter={StaticResource ValueToVisibilityConverter}}">
                                            <Path Data="{StaticResource IconExclamation}" Fill="Yellow" />
                                        </Viewbox>
                                    </Grid>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </ScrollViewer>
                </Grid>

                <!-- Gridsplitter -->
                <GridSplitter Style="{StaticResource GenericGridSplitter}" Grid.Column="1" HorizontalAlignment="Center" Margin="0,-10,0,20" />

                <!-- Right column -->
                <Grid Column="2">

                    <!-- Mod details -->
                    <ScrollViewer Margin="0,0,-15,0" Visibility="{Binding Path=ModsVm.SelectedMod, Converter={StaticResource ValueToVisibilityConverter}}">
                        <StackPanel Margin="0,0,15,0">
                            <TextBlock Text="{Binding Path=ModsVm.SelectedMod.Title, FallbackValue=Title}" Foreground="#B2FFFFFF" FontSize="24" FontFamily="Segoe UI Semilight" TextTrimming="CharacterEllipsis" />
                            <TextBlock Text="{Binding Path=ModsVm.SelectedMod.Description, FallbackValue=Description}" Foreground="#66FFFFFF" Margin="0,10,0,40" TextWrapping="Wrap" />

                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="1*" />
                                    <ColumnDefinition Width="5*" />
                                </Grid.ColumnDefinitions>
                                <TextBlock Style="{StaticResource PropertyGroupDescriptorTextBlock}" Text="Mod info" />
                                <StackPanel Grid.Column="1">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition />
                                            <ColumnDefinition />
                                        </Grid.ColumnDefinitions>
                                        <StackPanel>
                                            <TextBlock Style="{StaticResource PropertyDescriptorTextBlock}" Text="Installed version" />
                                        <TextBlock Style="{StaticResource PropertyValueTextBlock}" Text="{Binding Path=ModsVm.SelectedMod.InstalledVersion, FallbackValue=Version}" />
                                        </StackPanel>

                                        <StackPanel Grid.Column="1" Visibility="{Binding Path=ModsVm.SelectedMod.RemoteVersion, Converter={StaticResource ValueToVisibilityConverter}}">
                                            <TextBlock Style="{StaticResource PropertyDescriptorTextBlock}" Text="Latest version" />
                                            <TextBlock Style="{StaticResource PropertyValueTextBlock}" Text="{Binding Path=ModsVm.SelectedMod.RemoteVersion, FallbackValue=Version}" />
                                        </StackPanel>
                                    </Grid>

                                    <TextBlock Style="{StaticResource PropertyDescriptorTextBlock}" Text="Factorio version" />
                                    <TextBlock Style="{StaticResource PropertyValueTextBlock}" Text="{Binding Path=ModsVm.SelectedMod.FactorioVersion, FallbackValue=Version}" />

                                    <TextBlock Style="{StaticResource PropertyDescriptorTextBlock}" Text="Author" />
                                    <TextBlock Style="{StaticResource PropertyValueTextBlock}" Text="{Binding Path=ModsVm.SelectedMod.Author, FallbackValue=Author}" />

                                    <TextBlock Style="{StaticResource PropertyDescriptorTextBlock}" Text="Homepage" Visibility="{Binding Path=ModsVm.SelectedMod.Homepage, Converter={StaticResource ValueToVisibilityConverter}}" />
                                    <TextBlock Style="{StaticResource PropertyValueTextBlock}" Visibility="{Binding Path=ModsVm.SelectedMod.Homepage, Converter={StaticResource ValueToVisibilityConverter}}" Foreground="{StaticResource AccentColorLight}" TextDecorations="Underline" TextTrimming="CharacterEllipsis">
                                        <Hyperlink Command="{Binding Path=ModsVm.OpenHyperlinkCmd}" Foreground="{StaticResource AccentColorLight}">
                                            <Run Text="{Binding Path=ModsVm.SelectedMod.Homepage, FallbackValue=Homepage}" />
                                        </Hyperlink>
                                    </TextBlock>

                                    <TextBlock Style="{StaticResource PropertyDescriptorTextBlock}" Text="Dependencies" Visibility="{Binding Path=ModsVm.SelectedMod.Dependencies, Converter={StaticResource ValueToVisibilityConverter}}" />
                                    <ListBox Style="{StaticResource GenericListBox}" ItemContainerStyle="{StaticResource DependeciesListBoxItem}" ItemsSource="{Binding Path=ModsVm.SelectedMod.Dependencies}" Visibility="{Binding Path=ModsVm.SelectedMod.Dependencies, Converter={StaticResource ValueToVisibilityConverter}}" Margin="0,0,0,8" />

                                    <StackPanel Margin="0,15" Visibility="Collapsed">
                                        <Rectangle Height="12" />
                                        <TextBlock Style="{StaticResource PropertyDebugValueTextBlock}" Text="{Binding Path=ModsVm.SelectedMod.Filename, StringFormat={}Filename:  {0}}" />
                                        <TextBlock Style="{StaticResource PropertyDebugValueTextBlock}" Text="{Binding Path=ModsVm.SelectedMod.FilenameWithoutExtenion, StringFormat={}FilenameWithoutExtenion:  {0}}" />
                                        <TextBlock Style="{StaticResource PropertyDebugValueTextBlock}" Text="{Binding Path=ModsVm.SelectedMod.FullName, StringFormat={}FullName:  {0}}" />
                                        <TextBlock Style="{StaticResource PropertyDebugValueTextBlock}" Text="{Binding Path=ModsVm.SelectedMod.RemoteFilename, StringFormat={}RemoteFilename:  {0}}" />
                                        <TextBlock Style="{StaticResource PropertyDebugValueTextBlock}" Text="{Binding Path=ModsVm.SelectedMod.IsEnabled, StringFormat={}IsEnabled:  {0}}" />
                                        <TextBlock Style="{StaticResource PropertyDebugValueTextBlock}" Text="{Binding Path=ModsVm.SelectedMod.IsUpdating, StringFormat={}IsUpdating:  {0}}" />
                                        <TextBlock Style="{StaticResource PropertyDebugValueTextBlock}" Text="{Binding Path=ModsVm.SelectedMod.UpdateAvailable, StringFormat={}UpdateAvailable:  {0}}" />
                                        <TextBlock Style="{StaticResource PropertyDebugValueTextBlock}" Text="{Binding Path=ModsVm.SelectedMod.ProgressPercentage, StringFormat={}ProgressPercentage:  {0}}" />
                                        <Rectangle Height="12" />
                                    </StackPanel>
                                </StackPanel>
                            </Grid>
                        </StackPanel>
                    </ScrollViewer>
                </Grid>
            </Grid>

            <!-- Root - Settings -->
            <Grid Row="1" Background="#FF1E1E1E" Visibility="{Binding ElementName=SettingsButton, Path=IsChecked, Converter={StaticResource ValueToVisibilityConverter}}">
                <Grid Margin="20,30,20,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="1*" />
                        <ColumnDefinition Width="4*" />
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>
                    <TextBlock Style="{StaticResource PropertyGroupDescriptorTextBlock}" Text="Factorio settings" />
                    <StackPanel Grid.Column="1" Grid.Row="0" Margin="0,0,0,12">
                        <c:DescriptionTextBox DescriptionText="Factorio .exe path" Text="{Binding Path=ConfigVm.FactorioExePath, Mode=TwoWay}" />
                        <c:DescriptionTextBox DescriptionText="Mods folder path" Text="{Binding Path=ConfigVm.ModsPath, Mode=TwoWay}" />
                    </StackPanel>
                    
                     <TextBlock Grid.Column="0" Grid.Row="1" Style="{StaticResource PropertyGroupDescriptorTextBlock}" Text="Application settings" />
                    <StackPanel Grid.Column="1" Grid.Row="1" Margin="0,0,0,12">
                        <CheckBox Style="{StaticResource SettingsCheckBox}" IsChecked="{Binding Path=ConfigVm.AutoCheckModUpdate, Mode=TwoWay}" Content="Check for mod updates at startup" />
                        <CheckBox Style="{StaticResource SettingsCheckBox}" IsChecked="{Binding Path=ConfigVm.AutoDownloadModUpdate, Mode=TwoWay}" Content="Update mods automatically" />
                        <CheckBox Style="{StaticResource SettingsCheckBox}" IsChecked="{Binding Path=ConfigVm.AutoHideNotifyBanner, Mode=TwoWay}" Content="Hide the notification banner automatically after 10 seconds" />
                    </StackPanel>

                    <TextBlock Grid.Column="0" Grid.Row="2" Style="{StaticResource PropertyGroupDescriptorTextBlock}" Text="Mod portal settings" />
                    <StackPanel Grid.Column="1" Grid.Row="2">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition />
                                <ColumnDefinition />
                            </Grid.ColumnDefinitions>
                            <c:DescriptionTextBox DescriptionText="Username" Text="{Binding Path=ConfigVm.ModPortalUsername, Mode=TwoWay}" Margin="0,0,12,0" />
                            <c:DescriptionTextBox Grid.Column="1" DescriptionText="Password" Text="{Binding Path=ConfigVm.ModPortalPassword, Mode=TwoWay}" IsPasswordBox="True" />
                        </Grid>
                    </StackPanel>
                </Grid>
            </Grid>
        </Grid>

        <!-- Notify banner -->
        <AdornerDecorator x:Name="AdornerNotify" Height="35" MinWidth="400" Margin="0,0,0,15" HorizontalAlignment="Center" VerticalAlignment="Bottom" Grid.RowSpan="2" Visibility="{Binding Path=ModsVm.ShowNotifyBanner, Converter={StaticResource ValueToVisibilityConverter}}" IsVisibleChanged="AdornerNotify_IsVisibleChanged">
            <Border Background="#99111111" CornerRadius="12">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <TextBlock Text="{Binding Path=ModsVm.NotifyBannerValue}" Foreground="#7FFFFFFF" VerticalAlignment="Center" HorizontalAlignment="Center" Margin="25,0,0,0" />
                    <c:IconButton Grid.Column="1" Style="{StaticResource NotifyButton}" Icon="{StaticResource IconClose}" Command="{Binding Path=ModsVm.CloseNotifyBannerCmd}" Margin="0,0,5,0" ToolTip="Close" />
                </Grid>
            </Border>
        </AdornerDecorator>

        <!--  Apply button  -->
        <AdornerDecorator x:Name="AdornerApplyButton" Width="80" Height="80" Margin="0,60,15,0" HorizontalAlignment="Right" VerticalAlignment="Top" Grid.RowSpan="2">
            <c:IconButton Foreground="#FFFEFEFE" Style="{StaticResource ApplyButton}" ToolTip="Launch Factorio!" Command="{Binding Path=ModsVm.LaunchFactorioCmd}">
                <c:IconButton.Effect>
                    <DropShadowEffect BlurRadius="9" Direction="0" Opacity="0.53" RenderingBias="Quality" ShadowDepth="0" />
                </c:IconButton.Effect>
            </c:IconButton>
        </AdornerDecorator>
    </Grid>
</Window>
